<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" th:href="@{/css/index.css}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
          crossorigin="anonymous"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
            crossorigin="anonymous"></script>
    <title>DESI 2025</title>
</head>
<body>
<th:block th:replace="~{fragments/navbar :: navBar}"></th:block>
<div id="main-content" class="container mt-4">

    <form method="post" th:action="@{/receta/guardar}">
        <div class="mb-3">
            <label class="form-label">Nombre receta</label>
            <input type="text" class="form-control" name="nombre" required />
        </div>
        <div class="mb-3">
            <label class="form-label">Descripcion</label>
            <input type="text" class="form-control" name="descripcion" required />
        </div>

        <div id="ingredient-control" class="mt-3">
            <div class="d-flex gap-2 mb-2">
                <button id="btn-enable-product" type="button" class="btn btn-primary">Agregar producto</button>
                <button id="btn-enable-condiment" type="button" class="btn btn-secondary">Agregar condimento</button>
            </div>

            <!-- Panel producto -->
            <div id="add-product-panel" class="d-none mt-2">
                <div class="input-group">
                    <select id="select-product" class="form-select">
                        <option value="" disabled selected>Seleccionar producto...</option>
                        <option th:each="producto : ${productos}" th:value="${producto.id}" th:text="${producto.nombre}"></option>
                    </select>
                    <button id="btn-confirm-product" type="button" class="btn btn-success" title="Agregar">✅</button>
                    <button id="btn-cancel-product" type="button" class="btn btn-outline-secondary" title="Cancelar">Cancelar</button>
                </div>
            </div>

            <!-- Panel condimento -->
            <div id="add-condiment-panel" class="d-none mt-2">
                <div class="input-group">
                    <select id="select-condiment" class="form-select">
                        <option value="" disabled selected>Seleccionar condimento...</option>
                        <option th:each="condimento : ${condimentos}" th:value="${condimento.id}" th:text="${condimento.nombre}"></option>
                    </select>
                    <button id="btn-confirm-condiment" type="button" class="btn btn-success" title="Agregar">✅</button>
                    <button id="btn-cancel-condiment" type="button" class="btn btn-outline-secondary" title="Cancelar">Cancelar</button>
                </div>
            </div>

            <!-- Listas mostradas -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <label class="form-label">Productos agregados</label>
                    <div id="selected-products" class="mt-2"></div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Condimentos agregados</label>
                    <div id="selected-condiments" class="mt-2"></div>
                </div>
            </div>

            <!-- Botón final -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Guardar receta</button>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btnEnableProduct = document.getElementById('btn-enable-product');
        const btnEnableCondiment = document.getElementById('btn-enable-condiment');
        const productPanel = document.getElementById('add-product-panel');
        const condimentPanel = document.getElementById('add-condiment-panel');
        const btnCancelProduct = document.getElementById('btn-cancel-product');
        const btnCancelCondiment = document.getElementById('btn-cancel-condiment');
        const btnConfirmProduct = document.getElementById('btn-confirm-product');
        const btnConfirmCondiment = document.getElementById('btn-confirm-condiment');
        const selectProduct = document.getElementById('select-product');
        const selectCondiment = document.getElementById('select-condiment');
        const selectedProducts = document.getElementById('selected-products');
        const selectedCondiments = document.getElementById('selected-condiments');

        btnEnableProduct.addEventListener('click', () => {
            productPanel.classList.remove('d-none');
            condimentPanel.classList.add('d-none');
            selectProduct.focus();
        });

        btnEnableCondiment.addEventListener('click', () => {
            condimentPanel.classList.remove('d-none');
            productPanel.classList.add('d-none');
            selectCondiment.focus();
        });

        btnCancelProduct.addEventListener('click', () => {
            productPanel.classList.add('d-none');
            selectProduct.selectedIndex = 0;
        });

        btnCancelCondiment.addEventListener('click', () => {
            condimentPanel.classList.add('d-none');
            selectCondiment.selectedIndex = 0;
        });

        // Confirmar producto (CON CANTIDAD)
        btnConfirmProduct.addEventListener('click', () => {
            const value = selectProduct.value;
            const text = selectProduct.options[selectProduct.selectedIndex]?.text || '';
            if (!value) return;

            const row = document.createElement('div');
            row.className = 'd-flex align-items-center mb-2';

            const badge = document.createElement('span');
            badge.className = 'badge bg-light text-dark me-2';
            badge.textContent = text;

            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = 'productoIds';
            hiddenId.value = value;

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.name = 'productoCantidades';
            quantityInput.className = 'form-control form-control-sm me-2';
            quantityInput.style.width = '100px';
            quantityInput.placeholder = 'Cantidad';
            quantityInput.min = '0.01';
            quantityInput.step = '0.01';
            quantityInput.value = '1';
            quantityInput.required = true;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-outline-danger ms-2';
            removeBtn.textContent = 'Eliminar';

            row.appendChild(badge);
            row.appendChild(hiddenId);
            row.appendChild(quantityInput);
            row.appendChild(removeBtn);
            selectedProducts.appendChild(row);

            selectProduct.selectedIndex = 0;
            selectProduct.focus();

            removeBtn.addEventListener('click', () => selectedProducts.removeChild(row));
        });

        // Confirmar condimento (SIN CANTIDAD)
        btnConfirmCondiment.addEventListener('click', () => {
            const value = selectCondiment.value;
            const text = selectCondiment.options[selectCondiment.selectedIndex]?.text || '';
            if (!value) return;

            const row = document.createElement('div');
            row.className = 'd-flex align-items-center mb-2';

            const badge = document.createElement('span');
            badge.className = 'badge bg-light text-dark me-2';
            badge.textContent = text;

            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = 'condimentoIds';
            hiddenId.value = value;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-outline-danger ms-2';
            removeBtn.textContent = 'Eliminar';

            row.appendChild(badge);
            row.appendChild(hiddenId);
            row.appendChild(removeBtn);
            selectedCondiments.appendChild(row);

            selectCondiment.selectedIndex = 0;
            selectCondiment.focus();

            removeBtn.addEventListener('click', () => selectedCondiments.removeChild(row));
        });
    });
</script>
</body>
</html>