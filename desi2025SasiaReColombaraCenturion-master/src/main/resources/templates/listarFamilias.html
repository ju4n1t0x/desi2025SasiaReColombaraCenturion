<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de Familias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
<div class="container my-4">
    <h1 class="mb-4">Listado de Familias</h1>

    <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${mensaje}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="mb-3">
        <a href="/familias/nuevo" class="btn btn-primary">Crear Nueva Familia</a>
    </div>

    <div id="noFamiliasAlert" th:if="${listaFamilias.empty}" class="alert alert-info">
        No hay familias activas registradas.
    </div>

    <table th:unless="${listaFamilias.empty}" class="table table-striped table-hover" id="tablaFamilias">
        <thead class="table-dark">
        <tr>
            <th>
                Nro. Familia
                <input type="text" id="filtroNroFamilia" class="form-control form-control-sm mt-1" placeholder="Filtrar ID" onkeyup="filtrarTabla()" />
            </th>
            <th>
                Nombre
                <input type="text" id="filtroNombreFamilia" class="form-control form-control-sm mt-1" placeholder="Filtrar Nombre" onkeyup="filtrarTabla()" />
            </th>
            <th>Fecha de Registro</th>
            <th>Integrantes</th> <th colspan="3">Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="familia : ${listaFamilias}">
            <td th:text="${familia.nroFamilia}"></td>
            <td th:text="${familia.nombre}"></td>
            <td th:text="${#temporals.format(familia.fechaRegistro, 'dd-MM-yyyy')}"></td>
            <td th:text="${familia.cantidadIntegrantesActivos}"></td>
            <td>
                <a th:href="@{/familias/{nroFamilia}/asistidos(nroFamilia=${familia.nroFamilia})}" class="btn btn-secondary btn-sm">Ver Integrantes</a>
                <a th:href="@{/familias/{nroFamilia}/asistidos/nuevo(nroFamilia=${familia.nroFamilia})}" class="btn btn-info btn-sm me-1">Agregar Integrantes</a>
            </td>
            <td>
                <a th:href="@{/familias/editar/{id}(id=${familia.nroFamilia})}" class="btn btn-warning btn-sm me-1">Editar</a>
                <a th:href="@{/familias/eliminar/{id}(id=${familia.nroFamilia})}"
                   class="btn btn-danger btn-sm"
                   onclick="return confirm('¿Estás seguro de que quieres desactivar esta familia? Esto también desactivará a todos sus integrantes.');">Eliminar</a>
            </td>
        </tr>
        </tbody>
    </table>

    <div id="noCoincidencias" class="alert alert-warning" style="display: none;">
        No se encontraron familias que coincidan con los criterios de búsqueda.
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eOzPR3pSMfH/hGqfKXl/pxGnYm/k-hGqfKXl/pxGnYm/k-h8Q4-iJ-qK8l" crossorigin="anonymous"></script>

<script>
    function filtrarTabla() {
        let inputNro = document.getElementById("filtroNroFamilia");
        let inputNombre = document.getElementById("filtroNombreFamilia");

        if (!inputNro || !inputNombre) {
            console.error("Error: No se encontraron los elementos de filtro (filtroNroFamilia o filtroNombreFamilia). Revisa los IDs.");
            return;
        }

        let filterNro = inputNro.value.toLowerCase().trim();
        let filterNombre = inputNombre.value.toLowerCase().trim();

        let table = document.getElementById("tablaFamilias");
        if (!table) {
            console.error("Error: No se encontró la tabla con ID 'tablaFamilias'. Revisa el ID de la tabla.");
            return;
        }

        let tr = table.getElementsByTagName("tr");

        let initialEmptyAlert = document.getElementById("noFamiliasAlert");
        if (initialEmptyAlert) {
            initialEmptyAlert.style.display = "none";
        }

        let noCoincidenciasAlert = document.getElementById("noCoincidencias");
        noCoincidenciasAlert.style.display = "none";

        let visibleRowsCount = 0;

        // Iterar sobre todas las filas de la tabla (empezando desde la segunda para saltar el thead)
        for (let i = 1; i < tr.length; i++) {
            let tdNro = tr[i].getElementsByTagName("td")[0];   // Columna 0: Nro. Familia (para filtro)
            let tdNombre = tr[i].getElementsByTagName("td")[1]; // Columna 1: Nombre (para filtro)

            let foundMatchInRow = true;

            if (tdNro && tdNombre) {
                let nroValue = tdNro.textContent || tdNro.innerText;
                let nombreValue = tdNombre.textContent || tdNombre.innerText;

                // Si se está filtrando por Nro. Familia (y no está vacío)
                if (filterNro !== "") {
                    if (nroValue.toLowerCase().indexOf(filterNro) === -1) {
                        foundMatchInRow = false;
                    }
                }

                // Si se está filtrando por Nombre de Familia (y no está vacío) Y la fila sigue siendo una coincidencia
                if (filterNombre !== "" && foundMatchInRow) {
                    if (nombreValue.toLowerCase().indexOf(filterNombre) === -1) {
                        foundMatchInRow = false;
                    }
                }

                // Si ambos filtros están vacíos, mostrar todas las filas
                if (filterNro === "" && filterNombre === "") {
                    foundMatchInRow = true;
                }

                // Mostrar u ocultar la fila según el resultado del filtro
                if (foundMatchInRow) {
                    tr[i].style.display = "";
                    visibleRowsCount++;
                } else {
                    tr[i].style.display = "none";
                }
            }
        }

        // Lógica para mostrar el mensaje de "No se encontraron coincidencias"
        if (visibleRowsCount === 0 && (filterNro !== "" || filterNombre !== "")) {
            noCoincidenciasAlert.style.display = "block";
        } else {
            noCoincidenciasAlert.style.display = "none";
        }

        // Manejo del mensaje inicial "No hay familias activas registradas."
        if (visibleRowsCount === 0 && filterNro === "" && filterNombre === "" && initialEmptyAlert) {
            if (tr.length <= 1) {
                initialEmptyAlert.style.display = "block";
            }
        }
    }
</script>
</body>
</html>